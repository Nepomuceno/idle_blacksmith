name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GODOT_VERSION: "4.5.1"
  GAME_NAME: "IdleBlacksmith"

jobs:
  build-windows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import project
        run: |
          godot --headless --import
          godot --headless --import

      - name: Create export directory
        run: mkdir -p exports/windows

      - name: Export game
        run: godot --headless --export-release "Windows Desktop" exports/windows/${{ env.GAME_NAME }}.exe

      - name: Create ZIP archive
        run: |
          cd exports/windows
          zip -r ../../${{ env.GAME_NAME }}-Windows.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GAME_NAME }}-Windows
          path: ${{ env.GAME_NAME }}-Windows.zip
          retention-days: 1

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import project
        run: |
          godot --headless --import
          godot --headless --import

      - name: Create export directory
        run: mkdir -p exports/linux

      - name: Export game
        run: godot --headless --export-release "Linux" exports/linux/${{ env.GAME_NAME }}.x86_64

      - name: Create ZIP archive
        run: |
          cd exports/linux
          zip -r ../../${{ env.GAME_NAME }}-Linux.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GAME_NAME }}-Linux
          path: ${{ env.GAME_NAME }}-Linux.zip
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import project
        run: |
          godot --headless --import
          godot --headless --import

      - name: Create export directory
        run: mkdir -p exports/macos

      - name: Export game (unsigned)
        run: godot --headless --export-release "macOS" exports/macos/"Idle Blacksmith.app"

      - name: Import signing certificate
        if: ${{ env.APPLE_CERTIFICATE_BASE64 != '' }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          
          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Clean up certificate file
          rm $RUNNER_TEMP/certificate.p12

      - name: Code sign the app
        if: ${{ env.APPLE_CERTIFICATE_BASE64 != '' }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="exports/macos/Idle Blacksmith.app"
          
          # Get the signing identity (full name including "Developer ID Application:")
          IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)"/\1/')
          
          echo "Signing with identity: $IDENTITY"
          
          # Sign all frameworks and dylibs first (deep sign)
          find "$APP_PATH" -name "*.dylib" -o -name "*.framework" | while read -r item; do
            codesign --force --timestamp --options runtime --sign "$IDENTITY" "$item" || true
          done
          
          # Sign the main executable
          codesign --force --timestamp --options runtime --sign "$IDENTITY" "$APP_PATH/Contents/MacOS/Idle Blacksmith" || true
          
          # Sign the entire app bundle
          codesign --force --deep --timestamp --options runtime --sign "$IDENTITY" "$APP_PATH"
          
          # Verify signature
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      - name: Notarize the app
        if: ${{ env.APPLE_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="exports/macos/Idle Blacksmith.app"
          ZIP_PATH="exports/macos/Idle Blacksmith-notarize.zip"
          
          # Create ZIP for notarization
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"
          
          # Submit for notarization
          echo "Submitting for notarization..."
          xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --timeout 30m
          
          # Staple the notarization ticket
          echo "Stapling notarization ticket..."
          xcrun stapler staple "$APP_PATH"
          
          # Verify notarization
          xcrun stapler validate "$APP_PATH"
          
          # Clean up notarization zip
          rm "$ZIP_PATH"

      - name: Create final ZIP archive
        run: |
          cd exports/macos
          zip -r ../../${{ env.GAME_NAME }}-macOS.zip "Idle Blacksmith.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GAME_NAME }}-macOS
          path: ${{ env.GAME_NAME }}-macOS.zip
          retention-days: 1

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Configure Android export
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
        run: |
          # Decode keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > $RUNNER_TEMP/release.keystore
          
          # Configure Godot editor settings for Android
          mkdir -p ~/.config/godot
          cat > ~/.config/godot/editor_settings-4.tres << EOF
          [gd_resource type="EditorSettings" format=3]
          [resource]
          export/android/android_sdk_path = "$ANDROID_HOME"
          export/android/debug_keystore = "$RUNNER_TEMP/release.keystore"
          export/android/debug_keystore_user = "$ANDROID_KEYSTORE_ALIAS"
          export/android/debug_keystore_pass = "$ANDROID_KEYSTORE_PASSWORD"
          EOF
          
          # Update export_presets.cfg with keystore info
          sed -i 's|keystore/release = ".*"|keystore/release = "'$RUNNER_TEMP'/release.keystore"|g' export_presets.cfg
          sed -i 's|keystore/release_user = ".*"|keystore/release_user = "'$ANDROID_KEYSTORE_ALIAS'"|g' export_presets.cfg
          sed -i 's|keystore/release_password = ".*"|keystore/release_password = "'$ANDROID_KEYSTORE_PASSWORD'"|g' export_presets.cfg

      - name: Import project
        run: |
          godot --headless --import
          godot --headless --import

      - name: Create export directory
        run: mkdir -p exports/android

      - name: Export AAB (Android App Bundle)
        run: godot --headless --export-release "Android" exports/android/${{ env.GAME_NAME }}.aab

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.GAME_NAME }}-Android
          path: exports/android/${{ env.GAME_NAME }}.aab
          retention-days: 1

  release:
    needs: [build-windows, build-linux, build-macos, build-android]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display downloaded files
        run: ls -la artifacts/*/

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: get_previous_tag
        run: |
          # Get all tags sorted by version, find the one before current
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)
          if [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ] || [ -z "$PREVIOUS_TAG" ]; then
            # No previous tag, use first commit
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG="${{ steps.get_previous_tag.outputs.PREVIOUS_TAG }}"
          
          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
          
          # Create changelog file
          {
            echo "## What's Changed"
            echo ""
            
            # Features
            FEATURES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" | grep -E "^feat(\(.+\))?:" | sed 's/^feat(\([^)]*\)): /- **\1**: /' | sed 's/^feat: /- /' || true)
            if [ -n "$FEATURES" ]; then
              echo "### Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Fixes
            FIXES=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" | grep -E "^fix(\(.+\))?:" | sed 's/^fix(\([^)]*\)): /- **\1**: /' | sed 's/^fix: /- /' || true)
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # Other changes (docs, refactor, perf, etc.)
            OTHERS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" | grep -E "^(docs|refactor|perf|style|test|build|ci|chore)(\(.+\))?:" | sed 's/^\([a-z]*\)(\([^)]*\)): /- **\1(\2)**: /' | sed 's/^\([a-z]*\): /- **\1**: /' || true)
            if [ -n "$OTHERS" ]; then
              echo "### Other Changes"
              echo "$OTHERS"
              echo ""
            fi
            
            # If no conventional commits found, list all commits
            CONVENTIONAL_COUNT=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" | grep -E "^(feat|fix|docs|refactor|perf|style|test|build|ci|chore)(\(.+\))?:" | wc -l || echo "0")
            if [ "$CONVENTIONAL_COUNT" -eq 0 ]; then
              echo "### Commits"
              git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" || true
              echo ""
            fi
            
            echo "---"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
          } > CHANGELOG_BODY.md
          
          cat CHANGELOG_BODY.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Idle Blacksmith ${{ steps.get_version.outputs.VERSION }}"
          body_path: CHANGELOG_BODY.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            artifacts/${{ env.GAME_NAME }}-Windows/${{ env.GAME_NAME }}-Windows.zip
            artifacts/${{ env.GAME_NAME }}-macOS/${{ env.GAME_NAME }}-macOS.zip
            artifacts/${{ env.GAME_NAME }}-Linux/${{ env.GAME_NAME }}-Linux.zip
            artifacts/${{ env.GAME_NAME }}-Android/${{ env.GAME_NAME }}.aab
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
